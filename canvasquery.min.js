/*     
  Canvas Query 0.6.0
  http://canvasquery.org
  (c) 2012-2013 http://rezoner.net
  Canvas Query may be freely distributed under the MIT license.
*/
cq=CanvasQuery=function(){window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}();var e=function(t){if(arguments.length===0){var n=e.createCanvas(window.innerWidth,window.innerHeight);window.addEventListener("resize",function(){n.width=window.innerWidth;n.height=window.innerHeight})}else if(typeof t==="string"){var n=e.createCanvas(document.querySelector(t)[0])}else if(typeof t==="number"){var n=e.createCanvas(arguments[0],arguments[1])}else if(t instanceof Image){var n=e.createCanvas(t)}else if(t instanceof HTMLCanvasElement){var n=t}else if(t instanceof e.Wrapper){return t}return new e.Wrapper(n)};e.extend=function(){for(var e=1;e<arguments.length;e++){for(var t in arguments[e]){arguments[0][t]=arguments[e][t]}}return arguments[0]};e.augment=function(){for(var e=1;e<arguments.length;e++){_.extend(arguments[0],arguments[e]);arguments[e](arguments[0])}};e.extend(e,{keycodes:{37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"},cleanArray:function(e,t){var n=arguments[arguments.length-1];var r=typeof n==="function";for(var i=0,s=e.length;i<s;i++){if(e[i]===null||t&&e[i][t]){if(r){n(e[i])}e.splice(i--,1);s--}}},specialBlendFunctions:["color","value","hue","saturation"],blendFunctions:{normal:function(e,t){return t},overlay:function(e,t){e/=255;t/=255;var n=0;if(e<128)n=2*e*t;else n=1-2*(1-e)*(1-t);return Math.min(255,Math.max(0,n*255|0))},hardLight:function(t,n){return e.blendFunctions.overlay(n,t)},softLight:function(t,n){t/=255;n/=255;var r=(1-2*n)*t*t+2*n*t;return e.limitValue(r*255,0,255)},dodge:function(e,t){return 256*e/(255-t+1)},burn:function(e,t){return 255-256*(255-e)/(t+1)},multiply:function(e,t){return t*e/255},divide:function(t,n){return e.limitValue(256*t/(n+1),0,255)},screen:function(e,t){return 255-(255-t)*(255-e)/255},grainExtract:function(t,n){return e.limitValue(t-n+128,0,255)},grainMerge:function(t,n){return e.limitValue(t+n-128,0,255)},difference:function(e,t){return Math.abs(e-t)},addition:function(e,t){return Math.min(e+t,255)},substract:function(e,t){return Math.max(e-t,0)},darkenOnly:function(e,t){return Math.min(e,t)},lightenOnly:function(e,t){return Math.max(e,t)},color:function(t,n){var r=e.rgbToHsl(t);var i=e.rgbToHsl(n);return e.hslToRgb(i[0],i[1],r[2])},hue:function(t,n){var r=e.rgbToHsv(t);var i=e.rgbToHsv(n);if(!i[1])return e.hsvToRgb(r[0],r[1],r[2]);else return e.hsvToRgb(i[0],r[1],r[2])},value:function(t,n){var r=e.rgbToHsv(t);var i=e.rgbToHsv(n);return e.hsvToRgb(r[0],r[1],i[2])},saturation:function(t,n){var r=e.rgbToHsv(t);var i=e.rgbToHsv(n);return e.hsvToRgb(r[0],i[1],r[2])}},blend:function(t,n,r,i){if(typeof i==="undefined")i=1;var t=e(t);var n=e(n);var s=t.context;var o=n.context;var u=s.getImageData(0,0,t.canvas.width,t.canvas.height);var a=o.getImageData(0,0,n.canvas.width,n.canvas.height);var f=u.data;var l=a.data;var c=this.createImageData(t.canvas.width,t.canvas.height);var h=c.data;var p=e.blendFunctions[r];if(e.specialBlendFunctions.indexOf(r)!==-1){for(var d=0,v=f.length;d<v;d+=4){var m=p([f[d+0],f[d+1],f[d+2]],[l[d+0],l[d+1],l[d+2]]);h[d+0]=f[d+0]+(m[0]-f[d+0])*i;h[d+1]=f[d+1]+(m[1]-f[d+1])*i;h[d+2]=f[d+2]+(m[2]-f[d+2])*i;h[d+3]=f[d+3]}}else{for(var d=0,v=f.length;d<v;d+=4){var g=p(f[d+0],l[d+0]);var y=p(f[d+1],l[d+1]);var b=p(f[d+2],l[d+2]);h[d+0]=f[d+0]+(g-f[d+0])*i;h[d+1]=f[d+1]+(y-f[d+1])*i;h[d+2]=f[d+2]+(b-f[d+2])*i;h[d+3]=f[d+3]}}t.context.putImageData(c,0,0);return t},wrapValue:function(e,t,n){if(e<t){e=n+(e-t)}else if(e>n){e=t+(e-n)}return e},limitValue:function(e,t,n){return e<t?t:e>n?n:e},mix:function(e,t,n){return e+(t-e)*n},hexToRgb:function(e){return["0x"+e[1]+e[2]|0,"0x"+e[3]+e[4]|0,"0x"+e[5]+e[6]|0]},rgbToHex:function(e,t,n){return"#"+((1<<24)+(e<<16)+(t<<8)+n).toString(16).slice(1,7)},rgbToHsl:function(e,t,n){if(e instanceof Array){n=e[2];t=e[1];e=e[0]}e/=255,t/=255,n/=255;var r=Math.max(e,t,n),i=Math.min(e,t,n);var s,o,u=(r+i)/2;if(r==i){s=o=0}else{var a=r-i;o=u>.5?a/(2-r-i):a/(r+i);switch(r){case e:s=(t-n)/a+(t<n?6:0);break;case t:s=(n-e)/a+2;break;case n:s=(e-t)/a+4;break}s/=6}return[s,o,u]},hslToRgb:function(e,t,n){var r,i,s;if(t==0){r=i=s=n}else{function o(e,t,n){if(n<0)n+=1;if(n>1)n-=1;if(n<1/6)return e+(t-e)*6*n;if(n<1/2)return t;if(n<2/3)return e+(t-e)*(2/3-n)*6;return e}var u=n<.5?n*(1+t):n+t-n*t;var a=2*n-u;r=o(a,u,e+1/3);i=o(a,u,e);s=o(a,u,e-1/3)}return[r*255|0,i*255|0,s*255|0]},rgbToHsv:function(e,t,n){if(e instanceof Array){n=e[2];t=e[1];e=e[0]}e=e/255,t=t/255,n=n/255;var r=Math.max(e,t,n),i=Math.min(e,t,n);var s,o,u=r;var a=r-i;o=r==0?0:a/r;if(r==i){s=0}else{switch(r){case e:s=(t-n)/a+(t<n?6:0);break;case t:s=(n-e)/a+2;break;case n:s=(e-t)/a+4;break}s/=6}return[s,o,u]},hsvToRgb:function(e,t,n){var r,i,s;var o=Math.floor(e*6);var u=e*6-o;var a=n*(1-t);var f=n*(1-u*t);var l=n*(1-(1-u)*t);switch(o%6){case 0:r=n,i=l,s=a;break;case 1:r=f,i=n,s=a;break;case 2:r=a,i=n,s=l;break;case 3:r=a,i=f,s=n;break;case 4:r=l,i=a,s=n;break;case 5:r=n,i=a,s=f;break}return[r*255,i*255,s*255]},color:function(){var t=new e.Color;t.parse(arguments);return t},createCanvas:function(e,t){var n=document.createElement("Canvas");if(arguments[0]instanceof Image){var r=arguments[0];n.width=r.width;n.height=r.height;n.getContext("2d").drawImage(r,0,0)}else{n.width=e;n.height=t}return n},createImageData:function(e,t){return document.createElement("Canvas").getContext("2d").createImageData(e,t)}});e.Wrapper=function(e){this.context=e.getContext("2d");this.canvas=e};e.Wrapper.prototype={appendTo:function(e){if(typeof e==="object"){var t=e}else{var t=document.querySelector(e)}t.appendChild(this.canvas);return this},blendOn:function(t,n,r){e.blend(t,this,n,r);return this},blend:function(t,n,r){if(typeof t==="string"){var i=t;t=e(e.createCanvas(this.canvas.width,this.canvas.height));t.fillStyle(i).fillRect(0,0,this.canvas.width,this.canvas.height)}e.blend(this,t,n,r);return this},crop:function(e,t,n,r){this.context.drawImage(this.canvas,e,t,n,r,0,0,n,r);this.canvas.width=n;this.canvas.height=r;return this},colorToMask:function(t){t=e.color(t).toArray();var n=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var r=n.data;var i=[];for(var s=0,o=r.length;s<o;s+=4){if(r[s+0]==t[0]&&r[s+1]==t[1]&&r[s+2]==t[2])i.push(false);else i.push(true)}return i},applyMask:function(e){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var n=t.data;for(var r=0,i=n.length;r<i;r+=4){if(e[r/4]){}else{n[r+3]=0}}this.context.putImageData(t,0,0);return this},fillMask:function(e,t){t=this.color(t);var n=this.context.getImageData(0,0,sourceCanvas.width,sourceCanvas.height);var r=n.data;for(var i=0,s=r.length;i<s;i+=4){if(e[i/4]){}else{r[i+0]=t[0];r[i+1]=t[1];r[i+2]=t[2];r[i+3]=t[3]}}this.context.putImageData(n,0,0);return this},clear:function(e){if(e){this.context.fillStyle=e;this.context.fillRect(0,0,this.canvas.width,this.canvas.height)}else{this.context.clearRect(0,0,this.canvas.width,this.canvas.height)}return this},clone:function(){var t=e.createCanvas(this.canvas.width,this.canvas.height);t.getContext("2d").drawImage(this.canvas,0,0);return e(t)},fillStyle:function(e){this.context.fillStyle=e;return this},strokeStyle:function(e){this.context.strokeStyle=e;return this},setHsl:function(){if(arguments.length===1){var t=arguments[0]}else{var t=arguments}var n=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var r=n.data;var i,s,o,u,a,f,l,c=[],h=[];for(var p=0,d=r.length;p<d;p+=4){c=e.rgbToHsl(r[p+0],r[p+1],r[p+2]);a=t[0]===null?c[0]:e.limitValue(t[0],0,1);f=t[1]===null?c[1]:e.limitValue(t[1],0,1);l=t[2]===null?c[2]:e.limitValue(t[2],0,1);h=e.hslToRgb(a,f,l);r[p+0]=h[0];r[p+1]=h[1];r[p+2]=h[2]}this.context.putImageData(n,0,0);return this},shiftHsl:function(){if(arguments.length===1){var t=arguments[0]}else{var t=arguments}var n=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var r=n.data;var i,s,o,u,a,f,l,c=[],h=[];for(var p=0,d=r.length;p<d;p+=4){c=e.rgbToHsl(r[p+0],r[p+1],r[p+2]);a=t[0]===null?c[0]:e.wrapValue(c[0]+t[0],0,1);f=t[1]===null?c[1]:e.limitValue(c[1]+t[1],0,1);l=t[2]===null?c[2]:e.limitValue(c[2]+t[2],0,1);h=e.hslToRgb(a,f,l);r[p+0]=h[0];r[p+1]=h[1];r[p+2]=h[2]}this.context.putImageData(n,0,0);return this},convolute:function(t,n,r){if(typeof r==="undefined")r=1;if(typeof n==="undefined")n=1;var i=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var s=Math.sqrt(t.length)+.5|0;var o=s/2|0;var u=i.data;var a=i.width;var f=i.height;var l=a;var c=f;var h=e.createImageData(this.canvas.width,this.canvas.height);var p=h.data;for(var d=1;d<c-1;d++){for(var v=1;v<l-1;v++){var m=(d*l+v)*4;var g=0,y=0,b=0,w=0;for(var E=0;E<s;E++){for(var S=0;S<s;S++){var x=d+E-o;var T=v+S-o;if(x>=0&&x<f&&T>=0&&T<a){var N=(x*a+T)*4;var C=t[E*s+S]/r;g+=u[N+0]*C;y+=u[N+1]*C;b+=u[N+2]*C;w+=u[N+3]*C}}}p[m+0]=e.mix(u[m+0],g,n);p[m+1]=e.mix(u[m+1],y,n);p[m+2]=e.mix(u[m+2],b,n);p[m+3]=u[m+3]}}this.context.putImageData(h,0,0);return this},blur:function(e){return this.convolute([1,1,1,1,1,1,1,1,1],e,9)},sharpen:function(e){return this.convolute([0,-1,0,-1,5,-1,0,-1,0],e)},threshold:function(e){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var n=t.data;var r,i,s;for(var o=0;o<n.length;o+=4){var r=n[o];var i=n[o+1];var s=n[o+2];var u=.2126*r+.7152*i+.0722*s>=e?255:0;n[o]=n[o+1]=n[o+2]=u}this.context.putImageData(t,0,0);return this},sepia:function(){var t=this.context.getImageData(0,0,this.canvas.width,this.canvas.height);var n=t.data;var r,i,s;for(var o=0;o<n.length;o+=4){n[o+0]=e.limitValue(n[o+0]*.393+n[o+1]*.769+n[o+2]*.189,0,255);n[o+1]=e.limitValue(n[o+0]*.349+n[o+1]*.686+n[o+2]*.168,0,255);n[o+2]=e.limitValue(n[o+0]*.272+n[o+1]*.534+n[o+2]*.131,0,255)}this.context.putImageData(t,0,0);return this},onStep:function(e,t){var n=this;var r=Date.now();this.timer=setInterval(function(){var t=Date.now()-r;e.call(n,t);r=Date.now()},t);return this},onRender:function(e){function n(){requestAnimationFrame(n);e.call(t)}var t=this;requestAnimationFrame(n);return this},onMouseMove:function(e){var t=this;this.canvas.addEventListener("mousemove",function(n){e.call(t,n.layerX,n.layerY)});return this},onMouseDown:function(e){var t=this;this.canvas.addEventListener("mousemove",function(n){e.call(t,n.layerX,n.layerY,n.button)});return this},onMouseUp:function(e){var t=this;this.canvas.addEventListener("mousemove",function(n){e.call(t,n.layerX,n.layerY,n.button)});return this},onKeyDown:function(t){document.addEventListener("keydown",function(n){if(n.which>=48&&n.which<=90)var r=String.fromCharCode(n.which).toLowerCase();else var r=e.keycodes[n.which];t.call(self,r)});return this},onKeyUp:function(t){document.addEventListener("keyup",function(n){if(n.which>=48&&n.which<=90)var r=String.fromCharCode(n.which).toLowerCase();else var r=e.keycodes[n.which];t.call(self,r)});return this},onResize:function(e){var t=this;window.addEventListener("resize",function(){e.call(t,window.innerWidth,window.innerHeight)});e.call(t,window.innerWidth,window.innerHeight);return this}};var t=["arc","arcTo","beginPath","bezierCurveTo","clearRect","clip","closePath","createImageData","createLinearGradient","createRadialGradient","createPattern","drawFocusRing","drawImage","fill","fillRect","fillText","getImageData","isPointInPath","lineTo","measureText","moveTo","putImageData","quadraticCurveTo","rect","restore","rotate","save","scale","setTransform","stroke","strokeRect","strokeText","transform","translate"];for(var n=0;n<t.length;n++){var r=t[n];e.Wrapper.prototype[r]=Function("this.context."+r+".apply(this.context, arguments); return this;")}var i=["canvas","fillStyle","font","globalAlpha","globalCompositeOperation","lineCap","lineJoin","lineWidth","miterLimit","shadowOffsetX","shadowOffsetY","shadowBlur","shadowColor","strokeStyle","textAlign","textBaseline"];for(var n=0;n<i.length;n++){var r=i[n];e.Wrapper.prototype[r]=Function("if(arguments.length) { this.context."+r+" = arguments[0]; return this; } else { return this.context."+r+"; }")}e.Color=function(){if(arguments.length)this.parse(arguments)};e.Color.prototype={parse:function(t){if(typeof t[0]==="string"){var n=e.hexToRgb(t[0]);this[0]=n[0];this[1]=n[1];this[2]=n[2];this[3]=typeof t[1]==="undefined"?1:t[1]}else{this[0]=t[0];this[1]=t[1];this[2]=t[2];this[3]=typeof t[3]==="undefined"?1:t[3]}},toArray:function(){return[this[0],this[1],this[2],this[3]]},toRgb:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+")"},toRgba:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+", "+this[3]+")"},toHex:function(){return e.rgbToHex(this[0],this[1],this[2])},toHsl:function(){return e.rgbToHsl(this[0],this[1],this[2])},toHsv:function(){return e.rgbToHsv(this[0],this[1],this[2])}};return e}()