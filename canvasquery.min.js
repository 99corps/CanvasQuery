/*     
  Canvas Query 0.6.3
  http://canvasquery.org
  (c) 2012-2013 http://rezoner.net
  Canvas Query may be freely distributed under the MIT license.
*/

(function(h){h.requestAnimationFrame=h.requestAnimationFrame||h.webkitRequestAnimationFrame||h.mozRequestAnimationFrame||h.oRequestAnimationFrame||h.msRequestAnimationFrame||function(a){h.setTimeout(a,1E3/60)};var d=function(a){if(0===arguments.length){var b=d.createCanvas(h.innerWidth,h.innerHeight);h.addEventListener("resize",function(){b.width=h.innerWidth;b.height=h.innerHeight})}else if("string"===typeof a)b=d.createCanvas(document.querySelector(a)[0]);else if("number"===typeof a)b=d.createCanvas(arguments[0],
arguments[1]);else if(a instanceof Image)b=d.createCanvas(a);else if(a instanceof HTMLCanvasElement)b=a;else if(a instanceof d.Wrapper)return a;return new d.Wrapper(b)};d.extend=function(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[0][b]=arguments[a][b];return arguments[0]};d.augment=function(){for(var a=1;a<arguments.length;a++)_.extend(arguments[0],arguments[a]),arguments[a](arguments[0])};d.extend(d,{keycodes:{37:"left",38:"up",39:"right",40:"down",45:"insert",46:"delete",
8:"backspace",9:"tab",13:"enter",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"escape",32:"space",33:"pageup",34:"pagedown",35:"end",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scrolllock",186:"semicolon",187:"equal",188:"comma",189:"dash",190:"period",191:"slash",192:"graveaccent",219:"openbracket",220:"backslash",221:"closebraket",222:"singlequote"},cleanArray:function(a,b){for(var c=arguments[arguments.length-
1],e="function"===typeof c,d=0,f=a.length;d<f;d++)if(null===a[d]||b&&a[d][b])e&&c(a[d]),a.splice(d--,1),f--},specialBlendFunctions:["color","value","hue","saturation"],blendFunctions:{normal:function(a,b){return b},overlay:function(a,b){a/=255;b/=255;return Math.min(255,Math.max(0,255*(128>a?2*a*b:1-2*(1-a)*(1-b))|0))},hardLight:function(a,b){return d.blendFunctions.overlay(b,a)},softLight:function(a,b){a/=255;b/=255;return d.limitValue(255*((1-2*b)*a*a+2*b*a),0,255)},dodge:function(a,b){return 256*
a/(255-b+1)},burn:function(a,b){return 255-256*(255-a)/(b+1)},multiply:function(a,b){return b*a/255},divide:function(a,b){return d.limitValue(256*a/(b+1),0,255)},screen:function(a,b){return 255-(255-b)*(255-a)/255},grainExtract:function(a,b){return d.limitValue(a-b+128,0,255)},grainMerge:function(a,b){return d.limitValue(a+b-128,0,255)},difference:function(a,b){return Math.abs(a-b)},addition:function(a,b){return Math.min(a+b,255)},substract:function(a,b){return Math.max(a-b,0)},darkenOnly:function(a,
b){return Math.min(a,b)},lightenOnly:function(a,b){return Math.max(a,b)},color:function(a,b){var c=d.rgbToHsl(a),e=d.rgbToHsl(b);return d.hslToRgb(e[0],e[1],c[2])},hue:function(a,b){var c=d.rgbToHsv(a),e=d.rgbToHsv(b);return e[1]?d.hsvToRgb(e[0],c[1],c[2]):d.hsvToRgb(c[0],c[1],c[2])},value:function(a,b){var c=d.rgbToHsv(a),e=d.rgbToHsv(b);return d.hsvToRgb(c[0],c[1],e[2])},saturation:function(a,b){var c=d.rgbToHsv(a),e=d.rgbToHsv(b);return d.hsvToRgb(c[0],e[1],c[2])}},blend:function(a,b,c,e){"undefined"===
typeof e&&(e=1);a=d(a);b=d(b);var j=b.context,f=a.context.getImageData(0,0,a.canvas.width,a.canvas.height);b=j.getImageData(0,0,b.canvas.width,b.canvas.height);f=f.data;b=b.data;var j=this.createImageData(a.canvas.width,a.canvas.height),g=j.data,k=d.blendFunctions[c];if(-1!==d.specialBlendFunctions.indexOf(c)){c=0;for(var l=f.length;c<l;c+=4){var h=k([f[c+0],f[c+1],f[c+2]],[b[c+0],b[c+1],b[c+2]]);g[c+0]=f[c+0]+(h[0]-f[c+0])*e;g[c+1]=f[c+1]+(h[1]-f[c+1])*e;g[c+2]=f[c+2]+(h[2]-f[c+2])*e;g[c+3]=f[c+
3]}}else{c=0;for(l=f.length;c<l;c+=4){var h=k(f[c+0],b[c+0]),m=k(f[c+1],b[c+1]),n=k(f[c+2],b[c+2]);g[c+0]=f[c+0]+(h-f[c+0])*e;g[c+1]=f[c+1]+(m-f[c+1])*e;g[c+2]=f[c+2]+(n-f[c+2])*e;g[c+3]=f[c+3]}}a.context.putImageData(j,0,0);return a},wrapValue:function(a,b,c){a<b?a=c+(a-b):a>c&&(a=b+(a-c));return a},limitValue:function(a,b,c){return a<b?b:a>c?c:a},mix:function(a,b,c){return a+(b-a)*c},hexToRgb:function(a){return["0x"+a[1]+a[2]|0,"0x"+a[3]+a[4]|0,"0x"+a[5]+a[6]|0]},rgbToHex:function(a,b,c){return"#"+
(16777216+(a<<16)+(b<<8)+c).toString(16).slice(1,7)},rgbToHsl:function(a,b,c){a instanceof Array&&(c=a[2],b=a[1],a=a[0]);a/=255;b/=255;c/=255;var e=Math.max(a,b,c),d=Math.min(a,b,c),f,g=(e+d)/2;if(e==d)f=d=0;else{var k=e-d,d=0.5<g?k/(2-e-d):k/(e+d);switch(e){case a:f=(b-c)/k+(b<c?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f/=6}return[f,d,g]},hslToRgb:function(a,b,c){if(0==b)c=b=a=c;else{var e=function(a,c,b){0>b&&(b+=1);1<b&&(b-=1);return b<1/6?a+6*(c-a)*b:0.5>b?c:b<2/3?a+6*(c-a)*(2/3-
b):a},d=0.5>c?c*(1+b):c+b-c*b,f=2*c-d;c=e(f,d,a+1/3);b=e(f,d,a);a=e(f,d,a-1/3)}return[255*c|0,255*b|0,255*a|0]},rgbToHsv:function(a,b,c){a instanceof Array&&(c=a[2],b=a[1],a=a[0]);a/=255;b/=255;c/=255;var e=Math.max(a,b,c),d=Math.min(a,b,c),f,g=e-d;if(e==d)f=0;else{switch(e){case a:f=(b-c)/g+(b<c?6:0);break;case b:f=(c-a)/g+2;break;case c:f=(a-b)/g+4}f/=6}return[f,0==e?0:g/e,e]},hsvToRgb:function(a,b,c){var e,d,f,g=Math.floor(6*a),k=6*a-g;a=c*(1-b);var h=c*(1-k*b);b=c*(1-(1-k)*b);switch(g%6){case 0:e=
c;d=b;f=a;break;case 1:e=h;d=c;f=a;break;case 2:e=a;d=c;f=b;break;case 3:e=a;d=h;f=c;break;case 4:e=b;d=a;f=c;break;case 5:e=c,d=a,f=h}return[255*e,255*d,255*f]},color:function(){var a=new d.Color;a.parse(arguments);return a},createCanvas:function(a,b){var c=document.createElement("Canvas");a instanceof Image?(c.width=a.width,c.height=a.height,c.getContext("2d").drawImage(a,0,0)):(c.width=a,c.height=b);return c},createImageData:function(a,b){return document.createElement("Canvas").getContext("2d").createImageData(a,
b)}});d.Wrapper=function(a){this.context=a.getContext("2d");this.canvas=a};d.Wrapper.prototype={appendTo:function(a){("object"===typeof a?a:document.querySelector(a)).appendChild(this.canvas);return this},blendOn:function(a,b,c){d.blend(a,this,b,c);return this},blend:function(a,b,c){if("string"===typeof a){var e=a;a=d(d.createCanvas(this.canvas.width,this.canvas.height));a.fillStyle(e).fillRect(0,0,this.canvas.width,this.canvas.height)}d.blend(this,a,b,c);return this},crop:function(a,b,c,e){this.context.drawImage(this.canvas,
a,b,c,e,0,0,c,e);this.canvas.width=c;this.canvas.height=e;return this},resize:function(a,b){var c=d(a,b).drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,a,b);this.canvas=c.canvas;this.context=c.context;return this},matchPalette:function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=[],e=0;e<a.length;e++)c.push(d.color(a[e]));for(e=0;e<b.data.length;e+=4){for(var j=[],f=0;f<c.length;f++){var g=c[f],k=Math.abs(b.data[e]-g[0]),h=Math.abs(b.data[e+
1]-g[1]),g=Math.abs(b.data[e+2]-g[2]);j.push(k+h+g)}for(f=k=0;f<a.length;f++)j[f]<j[k]&&(k=f);j=cq.hexToRgb(a[k]);b.data[e]=j[0];b.data[e+1]=j[1];b.data[e+2]=j[2]}this.context.putImageData(b,0,0);return this},getPalette:function(){for(var a=[],b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data,c=0,e=b.length;c<e;c+=4)if(b[c+3]){var j=d.rgbToHex(b[c+0],b[c+1],b[c+2]);-1===a.indexOf(j)&&a.push(j)}return a},pixelize:function(a){if(!a)return this;var b=this.context.mozImageSmoothingEnabled,
c=this.context.webkitImageSmoothingEnabled;this.context.mozImageSmoothingEnabled=!1;this.context.webkitImageSmoothingEnabled=!1;a=this.canvas.width/(a||4)/this.canvas.width;this.drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,this.canvas.width*a|0,this.canvas.height*a|0);this.drawImage(this.canvas,0,0,this.canvas.width*a|0,this.canvas.height*a|0,0,0,this.canvas.width,this.canvas.height);this.context.mozImageSmoothingEnabled=b;this.context.webkitImageSmoothingEnabled=c;return this},
colorToMask:function(a){a=d.color(a).toArray();for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data,c=[],e=0,j=b.length;e<j;e+=4)b[e+0]==a[0]&&b[e+1]==a[1]&&b[e+2]==a[2]?c.push(!1):c.push(!0);return c},grayscaleToMask:function(a){d.color(a).toArray();a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height).data;for(var b=[],c=0,e=a.length;c<e;c+=4)b.push((a[c+0]+a[c+1]+a[c+2])/3|0);return b},applyMask:function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,
this.canvas.height),c=b.data,e="boolean"===typeof a[0]?"bool":"byte",d=0,f=c.length;d<f;d+=4){var g=a[d/4];c[d+3]="boolean"===e?255*g|0:g|0}this.context.putImageData(b,0,0);return this},fillMask:function(a){var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,e="boolean"===typeof a[0]?"bool":"byte",j=2===arguments.length?"normal":"gradient",f=d.color(arguments[1]);"gradient"===j&&(colorB=d.color(arguments[2]));for(var g=0,h=c.length;g<h;g+=4){var l=a[g/4];"byte"===e&&
(l/=255);"normal"===j?l&&(c[g+0]=f[0]*l|0,c[g+1]=f[1]*l|0,c[g+2]=f[2]*l|0,c[g+3]=255*l|0):(c[g+0]=f[0]+(colorB[0]-f[0])*l|0,c[g+1]=f[1]+(colorB[1]-f[1])*l|0,c[g+2]=f[2]+(colorB[2]-f[2])*l|0,c[g+3]=255)}this.context.putImageData(b,0,0);return this},clear:function(a){a?(this.context.fillStyle=a,this.context.fillRect(0,0,this.canvas.width,this.canvas.height)):this.context.clearRect(0,0,this.canvas.width,this.canvas.height);return this},clone:function(){var a=d.createCanvas(this.canvas.width,this.canvas.height);
a.getContext("2d").drawImage(this.canvas,0,0);return d(a)},fillStyle:function(a){this.context.fillStyle=a;return this},strokeStyle:function(a){this.context.strokeStyle=a;return this},setHsl:function(){var a=1===arguments.length?arguments[0]:arguments,b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,e,j,f;f=[];e=[];for(var g=0,h=c.length;g<h;g+=4)f=d.rgbToHsl(c[g+0],c[g+1],c[g+2]),e=null===a[0]?f[0]:d.limitValue(a[0],0,1),j=null===a[1]?f[1]:d.limitValue(a[1],0,1),f=null===
a[2]?f[2]:d.limitValue(a[2],0,1),e=d.hslToRgb(e,j,f),c[g+0]=e[0],c[g+1]=e[1],c[g+2]=e[2];this.context.putImageData(b,0,0);return this},shiftHsl:function(){var a=1===arguments.length?arguments[0]:arguments,b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),c=b.data,e,j,f;f=[];e=[];for(var g=0,h=c.length;g<h;g+=4)f=d.rgbToHsl(c[g+0],c[g+1],c[g+2]),e=null===a[0]?f[0]:d.wrapValue(f[0]+a[0],0,1),j=null===a[1]?f[1]:d.limitValue(f[1]+a[1],0,1),f=null===a[2]?f[2]:d.limitValue(f[2]+a[2],
0,1),e=d.hslToRgb(e,j,f),c[g+0]=e[0],c[g+1]=e[1],c[g+2]=e[2];this.context.putImageData(b,0,0);return this},convolute:function(a,b,c){"undefined"===typeof c&&(c=1);"undefined"===typeof b&&(b=1);for(var e=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),h=Math.sqrt(a.length)+0.5|0,f=h/2|0,g=e.data,k=e.width,e=e.height,l=d.createImageData(this.canvas.width,this.canvas.height),m=l.data,n=1;n<e-1;n++)for(var p=1;p<k-1;p++){for(var q=4*(n*k+p),v=0,w=0,x=0,t=0;t<h;t++)for(var u=0;u<h;u++){var r=
n+t-f,s=p+u-f;0<=r&&(r<e&&0<=s&&s<k)&&(r=4*(r*k+s),s=a[t*h+u]/c,v+=g[r+0]*s,w+=g[r+1]*s,x+=g[r+2]*s)}m[q+0]=d.mix(g[q+0],v,b);m[q+1]=d.mix(g[q+1],w,b);m[q+2]=d.mix(g[q+2],x,b);m[q+3]=g[q+3]}this.context.putImageData(l,0,0);return this},blur:function(a){return this.convolute([1,1,1,1,1,1,1,1,1],a,9)},gaussianBlur:function(a){return this.convolute([6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,1.9117E-4,0.00655965,
0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,3.8771E-4,0.01330373,0.11098164,0.22508352,0.11098164,0.01330373,3.8771E-4,1.9117E-4,0.00655965,0.05472157,0.11098164,0.05472157,0.00655965,1.9117E-4,2.292E-5,7.8633E-4,0.00655965,0.01330373,0.00655965,7.8633E-4,2.292E-5,6.7E-7,2.292E-5,1.9117E-4,3.8771E-4,1.9117E-4,2.292E-5,6.7E-7],a,1)},sharpen:function(a){return this.convolute([0,-1,0,-1,5,-1,0,-1,0],a)},threshold:function(a){for(var b=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),
c=b.data,d,h,f,g=0;g<c.length;g+=4)d=c[g],h=c[g+1],f=c[g+2],c[g]=c[g+1]=c[g+2]=0.2126*d+0.7152*h+0.0722*f>=a?255:0;this.context.putImageData(b,0,0);return this},sepia:function(){for(var a=this.context.getImageData(0,0,this.canvas.width,this.canvas.height),b=a.data,c=0;c<b.length;c+=4)b[c+0]=d.limitValue(0.393*b[c+0]+0.769*b[c+1]+0.189*b[c+2],0,255),b[c+1]=d.limitValue(0.349*b[c+0]+0.686*b[c+1]+0.168*b[c+2],0,255),b[c+2]=d.limitValue(0.272*b[c+0]+0.534*b[c+1]+0.131*b[c+2],0,255);this.context.putImageData(a,
0,0);return this},onStep:function(a,b){var c=this,d=Date.now();this.timer=setInterval(function(){var b=Date.now()-d;a.call(c,b);d=Date.now()},b);return this},onRender:function(a){function b(){requestAnimationFrame(b);a.call(c)}var c=this;requestAnimationFrame(b);return this},onMouseMove:function(a){var b=this;this.canvas.addEventListener("mousemove",function(c){a.call(b,c.layerX,c.layerY)});return this},onMouseDown:function(a){var b=this;this.canvas.addEventListener("mousemove",function(c){a.call(b,
c.layerX,c.layerY,c.button)});return this},onMouseUp:function(a){var b=this;this.canvas.addEventListener("mousemove",function(c){a.call(b,c.layerX,c.layerY,c.button)});return this},onKeyDown:function(a){document.addEventListener("keydown",function(b){b=48<=b.which&&90>=b.which?String.fromCharCode(b.which).toLowerCase():d.keycodes[b.which];a.call(self,b)});return this},onKeyUp:function(a){document.addEventListener("keyup",function(b){b=48<=b.which&&90>=b.which?String.fromCharCode(b.which).toLowerCase():
d.keycodes[b.which];a.call(self,b)});return this},onResize:function(a){var b=this;h.addEventListener("resize",function(){a.call(b,h.innerWidth,h.innerHeight)});a.call(b,h.innerWidth,h.innerHeight);return this}};for(var p="arc arcTo beginPath bezierCurveTo clearRect clip closePath createImageData createLinearGradient createRadialGradient createPattern drawFocusRing drawImage fill fillRect fillText getImageData isPointInPath lineTo measureText moveTo putImageData quadraticCurveTo rect restore rotate save scale setTransform stroke strokeRect strokeText transform translate".split(" "),
m=0;m<p.length;m++){var n=p[m];d.Wrapper.prototype[n]=Function("this.context."+n+".apply(this.context, arguments); return this;")}p="canvas fillStyle font globalAlpha globalCompositeOperation lineCap lineJoin lineWidth miterLimit shadowOffsetX shadowOffsetY shadowBlur shadowColor strokeStyle textAlign textBaseline".split(" ");for(m=0;m<p.length;m++)n=p[m],d.Wrapper.prototype[n]=Function("if(arguments.length) { this.context."+n+" = arguments[0]; return this; } else { return this.context."+n+"; }");
d.Color=function(){arguments.length&&this.parse(arguments)};d.Color.prototype={parse:function(a){if("string"===typeof a[0]){var b=d.hexToRgb(a[0]);this[0]=b[0];this[1]=b[1];this[2]=b[2];this[3]="undefined"===typeof a[1]?1:a[1]}else this[0]=a[0],this[1]=a[1],this[2]=a[2],this[3]="undefined"===typeof a[3]?1:a[3]},toArray:function(){return[this[0],this[1],this[2],this[3]]},toRgb:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+")"},toRgba:function(){return"rgb("+this[0]+", "+this[1]+", "+this[2]+
", "+this[3]+")"},toHex:function(){return d.rgbToHex(this[0],this[1],this[2])},toHsl:function(){return d.rgbToHsl(this[0],this[1],this[2])},toHsv:function(){return d.rgbToHsv(this[0],this[1],this[2])}};h.cq=h.CanvasQuery=d;"function"===typeof define&&define.amd&&define([],function(){return d})})(window);